# Telegram LLM Bot

Бот на Python, который отвечает через локальную LLM с OpenAI-совместимым API
(vLLM или LM Studio). В группе отвечает, если сообщение начинается с "Нука"
или если это ответ на сообщение бота.

## Быстрый старт

1) Создай бота в BotFather и возьми токен.
2) Скопируй `.env.example` в `.env` и заполни `TELEGRAM_BOT_TOKEN`.
3) Запусти локальную LLM:
   - LM Studio: включи Server и используй `http://localhost:1234/v1`.
   - vLLM: `python -m vllm.entrypoints.openai.api_server --model <model> --port 8000`
4) Установи зависимости и запусти:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python main.py
```

## Docker

Сборка и запуск:

```bash
docker build -t telegram-llm-bot .
docker run --env-file .env --name telegram-llm-bot --restart unless-stopped telegram-llm-bot
```

Если локальная LLM запущена на хосте, внутри контейнера `localhost` не виден.
Для macOS/Windows укажи `OPENAI_BASE_URL=http://host.docker.internal:1234/v1`.
Для Linux можно использовать `--network=host` при запуске контейнера.

## Использование

- Личные сообщения: бот отвечает на любой текст.
- Группы: напиши `Нука, ...` или ответь на сообщение бота.
  Если включен privacy mode в BotFather, бот видит только команды/упоминания,
  поэтому для триггера без упоминания нужно отключить privacy mode.
- `/reset` — очистить контекст диалога в этом чате.
- В группе можно очистить контекст сообщением `Нука, сброс` или `Нука, очистить`.
- При переполнении контекста бот удаляет самые старые сообщения и повторяет запрос.
- Если отвечаешь на сообщение человека, бот добавит этот текст в контекст запроса.
- `/help` — список команд и кнопки настроек.
- `/search <текст>` — поиск в интернете (если включен).
- Префикс `web:`/`search:`/`поиск:`/`найди в интернете` — выполнить поиск и передать результаты модели.

### Настройки в чате

Команды работают в личке и в группах:

- `/settings` — показать текущие настройки.
- `/setmood <текст>` — задать настроение ответов.
- `/clearmood` — очистить настроение.
- `/setprompt <текст>` — добавить доп. системные инструкции.
- `/clearprompt` — удалить доп. инструкции.
- `/setmax <число>` — ограничить размер ответа в токенах.
- `/settrigger <имя>` — изменить слово-триггер (например `Нука`).
- `/resetsettings` — сбросить настройки к значениям по умолчанию.
- `/cancel` — отменить ожидание ввода значения.

Настройки хранятся в памяти и сбрасываются при перезапуске бота.

Также при `/start` и `/settings` бот показывает кнопки для настройки.
Список команд в меню Telegram обновляется автоматически при запуске бота.

## Настройки

Все параметры берутся из `.env`:

- `OPENAI_BASE_URL` — URL локального API (`http://localhost:1234/v1` для LM Studio).
- `OPENAI_MODEL` — имя модели.
- `OPENAI_API_KEY` — токен (для локальных серверов можно оставить `not-needed`).
- `TRIGGER_WORD` — слово-триггер в группах (по умолчанию `Нука`).
- `SYSTEM_PROMPT`, `HISTORY_LIMIT`, `MAX_TOKENS`, `TEMPERATURE`, `REQUEST_TIMEOUT`.
- `CONTEXT_LIMIT_TOKENS` — лимит контекста модели (по умолчанию `32000`).
- `TOKEN_CHAR_RATIO` — грубая оценка токенов по символам (по умолчанию `4`).
- `ALLOWED_USER_IDS` — список `user_id` через запятую. Если пусто, доступ открыт.
- `WEB_SEARCH_ENABLED` — включить поиск в интернете (`1`/`0`).
- `WEB_SEARCH_PROVIDER` — провайдер поиска (`duckduckgo` или `serper`).
- `WEB_SEARCH_API_KEY` — ключ API (нужен для `serper`).
- `WEB_SEARCH_MAX_RESULTS` — число результатов (по умолчанию `5`).
- `WEB_SEARCH_TIMEOUT` — таймаут поиска в секундах (по умолчанию `15`).
